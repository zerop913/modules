<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <title>Чат-бот</title>
  </head>
  <body class="container mx-auto">
    <h2 class="text-2xl font-bold mb-4">Общие -> Общие модули</h2>
    <p class="text-gray-600">МодульРаботыСHTTP</p>
    <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code class="text-gray-800 font-mono">
        #Область ПрограммныйИнтерфейс

        Функция ПолучитьОбъектJSON(СтрокаJSON) Экспорт
            Попытка
                ЧтениеJSON = Новый ЧтениеJSON;
                ЧтениеJSON.УстановитьСтроку(СтрокаJSON);
                ОбъектJSON = ПрочитатьJSON(ЧтениеJSON);
                Возврат ОбъектJSON;
            Исключение
                ЗаписьЖурналаРегистрации("HTTPСервисы.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
                Возврат Неопределено;
            КонецПопытки;
        КонецФункции
        
        Функция ПолучитьСтрокуJSON(ОбъектJSON) Экспорт
            Попытка
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписатьJSON(ЗаписьJSON, ОбъектJSON);
                СтрокаСJSON = ЗаписьJSON.ПолучитьСтроку();
                Возврат СтрокаСJSON;
            Исключение
                ЗаписьЖурналаРегистрации("HTTPСервисы.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
                Возврат "";
            КонецПопытки;
        КонецФункции
        
        
        Функция ОтветJSON(Запрос, Объект, КодСостояния=200) Экспорт
            Попытка
                ДанныеЗапроса = МодульРаботыСHTTP.ПолучитьОбъектJSON(Запрос.ПолучитьТелоКакСтроку());
                HTTPСервисОтвет = Новый HTTPСервисОтвет(КодСостояния);
                HTTPСервисОтвет.УстановитьТелоИзСтроки(МодульРаботыСHTTP.ПолучитьСтрокуJSON(Объект));
                HTTPСервисОтвет.Заголовки.Вставить("Content-Type", "application/json");
                Возврат HTTPСервисОтвет;
            Исключение
                ЗаписьЖурналаРегистрации("HTTPСервисы.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
                Возврат МодульРаботыСHTTP.ОтветОбОшибке(ИнформацияОбОшибке());
            КонецПопытки;
        КонецФункции 
         
        
        Функция ПолучитьПростойУспешныйОтвет() Экспорт
            СтруктураОтвета = Новый Структура;
            СтруктураОтвета.Вставить("Result", "Its all good");
            Возврат ОтветJSON(, СтруктураОтвета);
        КонецФункции
        
        Функция ОтветОбОшибке(ИнформацияОбОшибке) Экспорт
            
            ЗаписьЖурналаРегистрации("HTTPСервисы.Ошибка",УровеньЖурналаРегистрации.Ошибка,,,
            ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
            Результат=Новый Структура;
            Результат.Вставить("Result","Error");
            Результат.Вставить("ErrorText",КраткоеПредставлениеОшибки(ИнформацияОбОшибке));
            
            Возврат ОтветJSON(Результат,500);
            
        КонецФункции 
        
        Процедура ЗаписатьЛог(ИмяМетода, Запрос, Ответ)  Экспорт 
            Попытка
                ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
                ОбъектJSON = МодульРаботыСHTTP.ПолучитьОбъектJSON(ТелоЗапроса);
                ТелоЗапросаJSON = МодульРаботыСHTTP.ПолучитьСтрокуJSON(ОбъектJSON);
            Исключение
                ТелоЗапросаJSON = "Ошибка при обработке JSON данных";
            КонецПопытки;
            
            НовыйЛог = Документы.ВходящиеЗапросы.СоздатьДокумент();
            НовыйЛог.Метод = ИмяМетода;
            НовыйЛог.ТелоЗапроса = ТелоЗапросаJSON;
            НовыйЛог.ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
            НовыйЛог.КодОтвета = Ответ.КодСостояния;
            НовыйЛог.Дата = ТекущаяДатаСеанса();
            
            НовыйЛог.Записать();
        КонецПроцедуры
        
        #КонецОбласти
    </code></pre>
    <p class="text-gray-600">МодульРаботыСТГ</p>
    <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code class="text-gray-800 font-mono">
        #Область ПрограммныйИнтерфейс 
        Функция ОбработатьВходящийЗапрос(Запрос) Экспорт 
            Попытка
                ДанныеЗапроса = МодульРаботыСHTTP.ПолучитьОбъектJSON(Запрос.ПолучитьТелоКакСтроку());	
                
                Если ТипЗнч(ДанныеЗапроса) = Тип("Структура") И ДанныеЗапроса.Свойство("message") Тогда
                    Возврат ОбработатьСообщение(ДанныеЗапроса.message);
                Иначе
                    Возврат МодульРаботыСHTTP.ПолучитьПростойУспешныйОтвет();
                КонецЕсли;
            Исключение
                Возврат МодульРаботыСHTTP.ОтветОбОшибке(ИнформацияОбОшибке());
            КонецПопытки;
        КонецФункции

        #КонецОбласти 


        #Область СлужебныеПроцедурыИФункции


        Функция ОбработатьСообщение(ДанныеСообщения)
            ИдентификаторЧата=ДанныеСообщения.Chat.id;
            
            СтруктураОтвета=Новый Структура;	
            СтруктураОтвета.Вставить("chat_id",ИдентификаторЧата);

            ТекстСообщения=ПолучитьТекстСообщения(ДанныеСообщения);
            ПолучательСообщения="";
            Если ДанныеСообщения.Свойство("from") тогда
                Отправитель=ДанныеСообщения.from;
                Если Отправитель.Свойство("username") тогда
                    ПолучательСообщения="@"+Отправитель.username;			
                ИначеЕсли Отправитель.Свойство("first_name") тогда
                    ПолучательСообщения=Отправитель.first_name;
                ИначеЕсли Отправитель.Свойство("last_name") тогда
                    ПолучательСообщения=Отправитель.last_name;
                Иначе
                    ПолучательСообщения=Отправитель.id;
                КонецЕсли;
            КонецЕсли;
            
            
            Если ДанныеСообщения.Свойство("text") тогда
                СтруктураОтвета.Вставить("method","sendMessage");
                СтруктураОтвета.Вставить("text",ПолучательСообщения+", "+ТекстСообщения);
                
            КонецЕсли;
            
            Возврат МодульРаботыСHTTP.ОтветJSON(СтруктураОтвета);
        КонецФункции 

        Функция ПолучитьТекстСообщения(ДанныеСообщения)

            ПодписьБота=Символы.ПС+"© бот";	
            Если ДанныеСообщения.Свойство("text") тогда
                ТекстСообщения=ДанныеСообщения.text+ПодписьБота;
            ИначеЕсли ДанныеСообщения.Свойство("caption") тогда
                ТекстСообщения=ДанныеСообщения.caption+ПодписьБота;
            Иначе
                ТекстСообщения="ошибка в распознавании сообщения 1с"+ПодписьБота;
            КонецЕсли;	
            Возврат ТекстСообщения
            
        КонецФункции

        #КонецОбласти
    </code></pre>
    <p class="text-gray-600">
      HTTP-сервисы -> TelegramWebhook
      <ol class="list-decimal space-y-2 ml-6">
        <li>Корневой url: TgBots</li>
        <li>
          Шаблоны: Ping (/Ping) -> GetPing (PingGetPing), Send (/Send) ->
          PostSend (SendPostSend)
        </li>
      </ol>
    </p>
    <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code class="text-gray-800 font-mono">
        Функция PingGetPing(Запрос)
            Возврат МодульРаботыСHTTP.ПолучитьПростойУспешныйОтвет();
        КонецФункции

        Функция SendPostSend(Запрос)	
            Попытка
                Ответ=МодульРаботыСТГ.ОбработатьВходящийЗапрос(Запрос);		
            Исключение
                Ответ=МодульРаботыСHTTP.ОтветОбОшибке(ИнформацияОбОшибке());		
            КонецПопытки;
            МодульРаботыСHTTP.ЗаписатьЛог("send",Запрос,Ответ);
            
            Возврат Ответ;
        КонецФункции
    </code></pre>
    <p class="text-gray-600">Документы -> Заказы -> Модуль объекта</p>
    <pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto"><code class="text-gray-800 font-mono">
        &НаСервере
        Перем ОбщегоНазначения Экспорт;
        
        &НаСервере
        Функция ОбработатьВходящийЗапрос(Запрос)
            ДанныеЗапроса = МодульРаботыСHTTP.ПолучитьОбъектJSON(Запрос.ПолучитьТелоКакСтроку());
            Попытка
                ДанныеЗапроса = МодульРаботыСHTTP.ПолучитьОбъектJSON(Запрос.ПолучитьТелоКакСтроку());
                Если ТипЗнч(ДанныеЗапроса) = Тип("Структура") И ДанныеЗапроса.Свойство("message") Тогда
                    Возврат ОбработатьСообщение(ДанныеЗапроса.message);
                Иначе
                    Возврат МодульРаботыСHTTP.ПолучитьПростойУспешныйОтвет();
                КонецЕсли;
            Исключение
                ЗаписьЖурналаРегистрации("ОбработкаВходящегоЗапроса", УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
                Возврат МодульРаботыСHTTP.ОтветОбОшибке(ИнформацияОбОшибке());
            КонецПопытки;
        КонецФункции
        
        &НаСервере
        Функция Цифры(Знач Строка) Экспорт
            Шаблон = "[0-9]+";
            Возврат СтрНайти(Строка, Шаблон) > 0;
        КонецФункции
        
        &НаСервере
        Функция ОбработатьСообщение(ДанныеСообщения)
            ИдентификаторЧата = ДанныеСообщения.Chat.id;
            СтруктураОтвета = Новый Структура;
            СтруктураОтвета.Вставить("chat_id", ИдентификаторЧата);
            СтруктураОтвета.Вставить("method", "sendMessage");
        
            ТекстСообщения = "";
            Если ДанныеСообщения.Свойство("text") Тогда
                ТекстСообщения = ДанныеСообщения.text;
            ИначеЕсли ДанныеСообщения.Свойство("caption") Тогда
                ТекстСообщения = ДанныеСообщения.caption;
            КонецЕсли;
        
            Если ТекстСообщения = "" Тогда
                СтруктураОтвета.Вставить("text", "Ошибка в распознавании сообщения 1С");
            ИначеЕсли Цифры(ТекстСообщения) И СтрДлина(ТекстСообщения) = 12 Тогда // Регистрация пользователя по номеру телефона
                ЗарегистрироватьПользователя(ИдентификаторЧата, ТекстСообщения);
                СтруктураОтвета.Вставить("text", "Вы зарегистрированы в системе!");
            ИначеЕсли ТекстСообщения = "/myorders" Тогда // Получение списка заказов пользователя
                СтруктураОтвета.Вставить("text", ПолучитьСписокЗаказов(ИдентификаторЧата));
            Иначе // Другие команды
                СтруктураОтвета.Вставить("text", "Неизвестная команда");
            КонецЕсли;
        
            Возврат МодульРаботыСHTTP.ОтветJSON(СтруктураОтвета);
        КонецФункции
        
        &НаСервере
        Процедура ЗарегистрироватьПользователя(ИдентификаторЧата, НомерТелефона)
            НовыйПользователь = Справочники.Пользователи.СоздатьЭлемент();
            НовыйПользователь.НомерТелефона = НомерТелефона;
            НовыйПользователь.ИдентификаторЧата = ИдентификаторЧата;
            НовыйПользователь.Записать();
        КонецПроцедуры
        
        &НаСервере
        Функция ПолучитьСписокЗаказов(ИдентификаторЧата)
            Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("ИдентификаторЧата", ИдентификаторЧата);
            Если Пользователь.Пустая() Тогда
                Возврат "Вы не зарегистрированы в системе. Отправьте свой номер телефона для регистрации.";
            КонецЕсли;
        
            Запрос = Новый Запрос;
            Запрос.Текст =
                "ВЫБРАТЬ
                |    Заказы.НомерЗаказа КАК НомерЗаказа,
                |    Заказы.СрокХранения КАК СрокХранения
                |ИЗ
                |    Документ.Заказы КАК Заказы
                |ГДЕ
                |    Заказы.НомерТелефонаКлиента = &НомерТелефона
                |    И Заказы.ИнформацияОДоставке = &НеВыдан";
            Запрос.УстановитьПараметр("НомерТелефона", Пользователь.НомерТелефона);
            Запрос.УстановитьПараметр("НеВыдан", Перечисления.ИнформацияОДоставке.НеВыдан);
        
            РезультатЗапроса = Запрос.Выполнить();
            ВыборкаЗаписей = РезультатЗапроса.Выбрать();
        
            ТекстОтвета = "";
            Пока ВыборкаЗаписей.Следующий() Цикл
                ТекстОтвета = ТекстОтвета + Символы.ПС + "Номер заказа: " + ВыборкаЗаписей.НомерЗаказа + ", Срок хранения: " + Формат(ВыборкаЗаписей.СрокХранения, "ДФ=dd.MM.yyyy");
            КонецЦикла;
        
            Если ТекстОтвета = "" Тогда
                ТекстОтвета = "У вас нет неполученных заказов.";
            КонецЕсли;
        
            Возврат ТекстОтвета;
        КонецФункции
        
        // Обработчики событий для оповещения клиентов
        
        &НаСервере
        Процедура ОбработкаПриЗаписи(Источник, Отказ)
            Если ТипЗнч(Источник) = Тип("ДокументОбъект.Заказы") Тогда
                ОповеститьОПоступленииЗаказа(Источник.Ссылка);
            КонецЕсли;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОповеститьОПоступленииЗаказа(ЗаказСсылка)
            Заказ = ЗаказСсылка.ПолучитьОбъект();
            Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("НомерТелефона", Заказ.НомерТелефонаКлиента);
            Если Не Пользователь.Пустая() Тогда
                ТекстСообщения = "Ваш заказ №" + Заказ.НомерЗаказа + " поступил на ПВЗ. Срок хранения: " + Формат(Заказ.СрокХранения, "ДФ=dd.MM.yyyy");
               ОтправитьСообщение(Пользователь.ИдентификаторЧата, ТекстСообщения);
           КонецЕсли;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОповеститьОСкоромИстеченииСрокаХранения()
           ТекущаяДата = ТекущаяДатаСеанса();
           Запрос = Новый Запрос;
           Запрос.Текст =
               "ВЫБРАТЬ
               |    Заказы.НомерЗаказа КАК НомерЗаказа,
               |    Заказы.СрокХранения КАК СрокХранения,
               |    Заказы.НомерТелефонаКлиента КАК НомерТелефона
               |ИЗ
               |    Документ.Заказы КАК Заказы
               |ГДЕ
               |    Заказы.СрокХранения = &ДатаИстеченияСрока
               |    И Заказы.ИнформацияОДоставке = &НеВыдан";
           Запрос.УстановитьПараметр("ДатаИстеченияСрока", ТекущаяДата + 1); // Плюс 1 день
           Запрос.УстановитьПараметр("НеВыдан", Перечисления.ИнформацияОДоставке.НеВыдан);
        
           РезультатЗапроса = Запрос.Выполнить();
           ВыборкаЗаписей = РезультатЗапроса.Выбрать();
        
           Пока ВыборкаЗаписей.Следующий() Цикл
               Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("НомерТелефона", ВыборкаЗаписей.НомерТелефона);
               Если Не Пользователь.Пустая() Тогда
                   ТекстСообщения = "Срок хранения вашего заказа №" + ВыборкаЗаписей.НомерЗаказа + " истекает завтра (" + Формат(ВыборкаЗаписей.СрокХранения, "ДФ=dd.MM.yyyy") + "). Просьба забрать заказ.";
                   ОтправитьСообщение(Пользователь.ИдентификаторЧата, ТекстСообщения);
               КонецЕсли;
           КонецЦикла;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОповеститьОВыдачеЗаказа(ЗаказСсылка)
           Заказ = ЗаказСсылка.ПолучитьОбъект();
           Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("НомерТелефона", Заказ.НомерТелефонаКлиента);
           Если Не Пользователь.Пустая() Тогда
               ТекстСообщения = "Ваш заказ №" + Заказ.НомерЗаказа + " был выдан. Просьба оценить работу сотрудника ПВЗ по шкале от 1 до 5.";
               ОтправитьСообщение(Пользователь.ИдентификаторЧата, ТекстСообщения);
               ДобавитьКомандуВОчередь(Пользователь.ИдентификаторЧата, "Оценка");
           КонецЕсли;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОбработатьКомандуОценка(ИдентификаторЧата, ТекстОценки)
           Попытка
               Оценка = Число(ТекстОценки);
               Если Оценка >= 1 И Оценка <= 5 Тогда
                   СохранитьОценкуСотрудника(ИдентификаторЧата, Оценка);
                   ТекстСообщения = "Спасибо за оценку! Желаете оставить отзыв о работе ПВЗ?";
                   ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения);
                   ДобавитьКомандуВОчередь(ИдентификаторЧата, "Отзыв");
               Иначе
                   ТекстСообщения = "Неверная оценка. Попробуйте снова (от 1 до 5).";
                   ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения);
                   ДобавитьКомандуВОчередь(ИдентификаторЧата, "Оценка");
               КонецЕсли;
           Исключение
               ТекстСообщения = "Неверная оценка. Попробуйте снова (от 1 до 5).";
               ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения);
               ДобавитьКомандуВОчередь(ИдентификаторЧата, "Оценка");
           КонецПопытки;
        КонецПроцедуры
        
        &НаСервере
        Процедура СохранитьОценкуСотрудника(ИдентификаторЧата, Оценка)
           Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("ИдентификаторЧата", ИдентификаторЧата);
           Если Не Пользователь.Пустая() Тогда
               НомерТелефона = Пользователь.НомерТелефона;
               Запрос = Новый Запрос;
               Запрос.Текст =
                   "ВЫБРАТЬ ПЕРВЫЕ 1
                   |    Заказы.СотрудникВыдавшийЗаказ КАК СотрудникВыдавшийЗаказ
                   |ИЗ
                   |    Документ.Заказы КАК Заказы
                   |ГДЕ
                   |    Заказы.НомерТелефонаКлиента = &НомерТелефона
                   |    И Заказы.ИнформацияОДоставке = &Выдан
                   |УПОРЯДОЧИТЬ ПО
                   |    Заказы.ДатаВыдачиЗаказа УБЫВ";
               Запрос.УстановитьПараметр("НомерТелефона", НомерТелефона);
               Запрос.УстановитьПараметр("Выдан", Перечисления.ИнформацияОДоставке.Выдан);
        
               РезультатЗапроса = Запрос.Выполнить();
               ВыборкаЗаписей = РезультатЗапроса.Выбрать();
        
               Если ВыборкаЗаписей.Следующий() Тогда
                   СотрудникВыдавшийЗаказ = ВыборкаЗаписей.СотрудникВыдавшийЗаказ;
                   НовыйОтзыв = РегистрыСведений.ОценкиСотрудников.СоздатьЭлемент();
                   НовыйОтзыв.Сотрудник = СотрудникВыдавшийЗаказ;
                   НовыйОтзыв.Оценка = Оценка;
                   НовыйОтзыв.Записать();
        
                   Если Оценка <= 2 Тогда // Негативная обратная связь
                       ОповеститьАдминистраторовОНегативнойОценке(Оценка, СотрудникВыдавшийЗаказ);
                   КонецЕсли;
               КонецЕсли;
           КонецЕсли;
        КонецПроцедуры
        
        
        &НаСервере
        Процедура ОповеститьАдминистраторовОНегативнойОценке(Оценка, СотрудникВыдавшийЗаказ)
           Администраторы = ПользователиИнформационнойБазы.ПолучитьПользователей();
           Для Каждого Администратор Из Администраторы Цикл
               Если Администратор.Роли.Найти(Метаданные.Роли.Администратор) <> Неопределено Тогда
                   ТекстСообщения = СтрШаблон("Получена негативная оценка (%1) для сотрудника %2. Просьба принять меры.", Оценка, Строка(СотрудникВыдавшийЗаказ));
                   ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, Администратор);
               КонецЕсли;
           КонецЦикла;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОбработатьКомандуОтзыв(ИдентификаторЧата, ТекстОтзыва)
           НовыйОтзыв = Документы.Отзывы.СоздатьДокумент();
           Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("ИдентификаторЧата", ИдентификаторЧата);
           Если Не Пользователь.Пустая() Тогда
               НовыйОтзыв.НомерТелефонаКлиента = Пользователь.НомерТелефона;
           КонецЕсли;
           НовыйОтзыв.ТекстОтзыва = ТекстОтзыва;
           НовыйОтзыв.Записать();
        КонецПроцедуры
        
        &НаСервере
        Процедура ДобавитьКомандуВОчередь(ИдентификаторЧата, Команда)
           НоваяКоманда = РегистрыСведений.ОчередьКомандТелеграмБота.СоздатьЭлемент();
           НоваяКоманда.ИдентификаторЧата = ИдентификаторЧата;
           НоваяКоманда.Команда = Команда;
           НоваяКоманда.Записать();
        КонецПроцедуры
        
        &НаСервере
        Процедура ОбработатьОчередьКоманд()
           Запрос = Новый Запрос;
           Запрос.Текст =
               "ВЫБРАТЬ
               |    ОчередьКомандТелеграмБота.ИдентификаторЧата КАК ИдентификаторЧата,
               |    ОчередьКомандТелеграмБота.Команда КАК Команда
               |ИЗ
               |    РегистрСведений.ОчередьКомандТелеграмБота КАК ОчередьКомандТелеграмБота";
        
           РезультатЗапроса = Запрос.Выполнить();
           ВыборкаЗаписей = РезультатЗапроса.Выбрать();
        
           Пока ВыборкаЗаписей.Следующий() Цикл
               ИдентификаторЧата = ВыборкаЗаписей.ИдентификаторЧата;
               Команда = ВыборкаЗаписей.Команда;
        
               Если Команда = "Оценка" Тогда
                   ТекстСообщения = "Оцените работу сотрудника ПВЗ по шкале от 1 до 5:";
                   ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения);
               ИначеЕсли Команда = "Отзыв" Тогда
                   ТекстСообщения = "Введите ваш отзыв о работе ПВЗ:";
                   ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения);
               КонецЕсли;
        
               НачатьОбработкуКоманды(ИдентификаторЧата, Команда);
           КонецЦикла;
        КонецПроцедуры
        
        &НаСервере
        Процедура НачатьОбработкуКоманды(ИдентификаторЧата, Команда)
           РегЗапись = РегистрыСведений.ОбрабатываемыеКомандыТелеграмБота.СоздатьЭлемент();
           РегЗапись.ИдентификаторЧата = ИдентификаторЧата;
           РегЗапись.Команда = Команда;
           РегЗапись.Записать();
        
           ОчиститьОчередьКоманд(ИдентификаторЧата);
        КонецПроцедуры
        
        &НаСервере
        Процедура ОчиститьОчередьКоманд(ИдентификаторЧата)
           НаборЗаписей = РегистрыСведений.ОчередьКомандТелеграмБота.СоздатьНаборЗаписей();
           НаборЗаписей.Отбор.ИдентификаторЧата.Установить(ИдентификаторЧата);
           НаборЗаписей.Записать();
        КонецПроцедуры
        
        &НаСервере
        Процедура ОбработатьВходящееСообщение(ИдентификаторЧата, ТекстСообщения)
           ЗаписьКоманды = РегистрыСведений.ОбрабатываемыеКомандыТелеграмБота.НайтиПоРеквизиту("ИдентификаторЧата", ИдентификаторЧата);
           Если Не ЗаписьКоманды.Пустая() Тогда
               Команда = ЗаписьКоманды.Команда;
               Если Команда = "Оценка" Тогда
                   ОбработатьКомандуОценка(ИдентификаторЧата, ТекстСообщения);
               ИначеЕсли Команда = "Отзыв" Тогда
                   ОбработатьКомандуОтзыв(ИдентификаторЧата, ТекстСообщения);
               КонецЕсли;
        
               ЗаписьКоманды.Удалить();
           КонецЕсли;
        КонецПроцедуры
        
        &НаСервере
        Процедура ОтправитьСообщение(ИдентификаторЧата, ТекстСообщения)
           HTTPСоединение = Новый HTTPСоединение("https://api.telegram.org", ,,,, Новый ЗащищенноеСоединениеOpenSSL);
           HTTPЗапрос = Новый HTTPЗапрос("bot7049821781:AAEURpqEcdGS2CFj4WmmfMCLAyLr2IQG3R0/setWebhook?url=https://1077-31-204-172-86.ngrok-free.app/telegram", HTTPСоединение);
           ПараметрыЗапроса = Новый Структура;
           ПараметрыЗапроса.Вставить("chat_id", ИдентификаторЧата);
           ПараметрыЗапроса.Вставить("text", ТекстСообщения);
           HTTPЗапрос.УстановитьТелоИзСтруктуры(ПараметрыЗапроса);
           Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
        КонецПроцедуры
        
        // Регламентное задание для ежедневной отправки уведомлений
        &НаСервере
        Процедура ОтправитьУведомленияОСрокеХранения()
           ОповеститьОСкоромИстеченииСрокаХранения();
           ОбработатьОчередьКоманд();
        КонецПроцедуры
        
        // Регламентное задание для ежедневной отправки уведомлений о заказах с истекшим сроком хранения
        &НаСервере
        Процедура ОтправитьУведомленияОЗаказахСИстекшимСрокомХранения()
           ОповеститьОЗаказахСИстекшимСрокомХранения();
        КонецПроцедуры
        
        &НаСервере
        Функция НайтиОбъект(ТипДокумента, Поле, Значение) Экспорт
            Запрос = Новый Запрос;
            Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ " + ТипДокумента + " ГДЕ " + Поле + " = &Значение";
            Запрос.УстановитьПараметр("Значение", Значение);
            Результат = Запрос.Выполнить();
            Выборка = Результат.Выбрать();
            Если Выборка.Следующий() Тогда
                Возврат Выборка.Ссылка;
            Иначе
                Возврат Неопределено;
            КонецЕсли;
        КонецФункции
        
        &НаСервере
        Процедура ОповеститьОЗаказахСИстекшимСрокомХранения()
           ТекущаяДата = ТекущаяДатаСеанса();
           Запрос = Новый Запрос;
           Запрос.Текст =
               "ВЫБРАТЬ
               |    Заказы.НомерЗаказа КАК НомерЗаказа,
               |    Заказы.СрокХранения КАК СрокХранения,
               |    Заказы.НомерТелефонаКлиента КАК НомерТелефона
               |ИЗ
               |    Документ.Заказы КАК Заказы
               |ГДЕ
               |    Заказы.СрокХранения < &ТекущаяДата
               |    И Заказы.ИнформацияОДоставке = &НеВыдан";
           Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата);
           Запрос.УстановитьПараметр("НеВыдан", Перечисления.ИнформацияОДоставке.НеВыдан);
        
           РезультатЗапроса = Запрос.Выполнить();
           ВыборкаЗаписей = РезультатЗапроса.Выбрать();
        
           Пока ВыборкаЗаписей.Следующий() Цикл
               Пользователь = Справочники.Пользователи.НайтиПоРеквизиту("НомерТелефона", ВыборкаЗаписей.НомерТелефона);
               Если Не Пользователь.Пустая() Тогда
                   ТекстСообщения = "Срок хранения вашего заказа №" + ВыборкаЗаписей.НомерЗаказа + " истек (" + Формат(ВыборкаЗаписей.СрокХранения, "ДФ=dd.MM.yyyy") + "). Заказ будет изъят со склада.";
                   ОтправитьСообщение(Пользователь.ИдентификаторЧата, ТекстСообщения);
                   ИзъятьЗаказСоСклада(ВыборкаЗаписей.НомерЗаказа);
               КонецЕсли;
           КонецЦикла;
        КонецПроцедуры
        
        &НаСервере
        Процедура ИзъятьЗаказСоСклада(НомерЗаказа)
           Заказ = НайтиОбъект("Документ.Заказы", "НомерЗаказа", НомерЗаказа);
           Если Заказ <> Неопределено Тогда
               Заказ.ИнформацияОДоставке = Перечисления.ИнформацияОДоставке.ИзъятСоСклада;
               Заказ.Записать();
           КонецЕсли;
        КонецПроцедуры
    </code></pre>
  </body>
</html>
